[program:web]
command=bash -c "{{ directory }}/repo/wait-for-it.sh redis://127.0.0.1:{{ redis_port }} && {{ directory }}/env/bin/gunicorn --bind 127.0.0.1:{{ web_port }} --workers {{ gunicorn_workers }} agent.web:application"
environment=PYTHONUNBUFFERED=1{% if sentry_dsn %}, SENTRY_DSN="{{ sentry_dsn }}"{% endif %}
autostart=true
autorestart=true
stdout_logfile={{ directory }}/logs/web.log
stderr_logfile={{ directory }}/logs/web.error.log
user={{ user }}
directory={{ directory }}

[program:redis]
command=redis-server redis.conf
autostart=true
autorestart=true
stdout_logfile={{ directory }}/logs/redis.log
stderr_logfile={{ directory }}/logs/redis.error.log
user={{ user }}
directory={{ directory }}

[program:worker]
command=bash -c "{{ directory }}/repo/wait-for-it.sh redis://127.0.0.1:{{ redis_port }} && exec {{ directory }}/env/bin/rq worker {% if sentry_dsn %}--sentry-dsn '{{ sentry_dsn }}'{% endif %} --url redis://127.0.0.1:{{ redis_port }} high default low"
environment=PYTHONUNBUFFERED=1
autostart=true
autorestart=true
stopwaitsecs=1500
killasgroup=true
numprocs={{ workers }}
process_name=%(program_name)s-%(process_num)d
stdout_logfile={{ directory }}/logs/worker.log
stderr_logfile={{ directory }}/logs/worker.error.log
user={{ user }}
directory={{ directory }}

{% if allow_sleepy_containers %}
[program:bench-starter]
command=bash -c "{{ directory }}/repo/wait-for-it.sh redis://127.0.0.1:{{ redis_port }} && exec {{directory}}/env/bin/python {{ directory }}/repo/agent/bench_starter.py"
environment=PYTHONUNBUFFERED=1
autostart=true
autorestart=true
stopwaitsecs=30
stdout_logfile={{ directory }}/logs/bench_starter.log
stderr_logfile={{ directory }}/logs/bench_starter.error.log
user={{ user }}
directory={{ directory }}

[program:bench-stopper]
command=bash -c "{{ directory }}/repo/wait-for-it.sh redis://127.0.0.1:{{ redis_port }} && exec {{directory}}/env/bin/python {{ directory }}/repo/agent/bench_stopper.py"
environment=PYTHONUNBUFFERED=1
autostart=true
autorestart=true
stopwaitsecs=30
stdout_logfile={{ directory }}/logs/bench_stopper.log
stderr_logfile={{ directory }}/logs/bench_stopper.error.log
user={{ user }}
directory={{ directory }}

{% endif %}

{% if is_proxy_server or is_standalone %}
[program:nginx_reload_manager]
command=bash -c "{{ directory }}/repo/wait-for-it.sh redis://127.0.0.1:{{ redis_port }} && exec {{directory}}/env/bin/python {{ directory }}/repo/agent/nginx_reload_manager.py"
environment=PYTHONUNBUFFERED=1
autostart=true
autorestart=true
stopwaitsecs=20
stdout_logfile={{ directory }}/logs/nginx_reload_manager.log
stderr_logfile={{ directory }}/logs/nginx_reload_manager.error.log
user={{ user }}
directory={{ directory }}
{% endif %}

[group:agent]
programs=web, redis, worker{% if is_proxy_server or is_standalone %}, nginx_reload_manager{% endif %}{% if allow_sleepy_containers %}, bench-starter, bench-stopper{% endif %}
